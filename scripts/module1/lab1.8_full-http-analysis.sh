#!/bin/bash
# Lab 1.8 : SynthÃ¨se - Analyse d'une requÃªte HTTP complÃ¨te
# Objectif : Consolider toutes les connaissances des couches rÃ©seau

set -e

echo "=== Lab 1.8 : Analyse complÃ¨te d'une requÃªte HTTP ==="
echo ""

echo "ğŸ¯ Objectif : Suivre une requÃªte HTTP de bout en bout"
echo "   et identifier chaque couche OSI impliquÃ©e"
echo ""

# Vider tous les caches
echo "1. Vidage des caches..."
echo "   - Cache ARP..."
sudo ip neigh flush all
echo "   - Cache DNS..."
sudo systemd-resolve --flush-caches 2>/dev/null || sudo resolvectl flush-caches 2>/dev/null || true
echo "âœ“ Caches vidÃ©s"
echo ""

echo "2. âš ï¸  INSTRUCTIONS WIRESHARK :"
echo "   - Ouvrez Wireshark"
echo "   - Appliquez le filtre : arp || dns || tcp.port == 80"
echo "   - Cliquez sur 'Start capturing'"
echo ""
read -p "Appuyez sur EntrÃ©e quand Wireshark est prÃªt..."
echo ""

# Effectuer une requÃªte HTTP
echo "3. ExÃ©cution de la requÃªte HTTP vers example.com..."
echo ""
curl -v http://example.com
echo ""

echo "=========================================="
echo "ğŸ“Š GUIDE D'ANALYSE DANS WIRESHARK"
echo "=========================================="
echo ""
echo "Vous devriez observer les Ã©tapes suivantes dans l'ordre chronologique :"
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  Ã‰tape â”‚ Protocole â”‚ Couche â”‚ Description                      â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  1     â”‚ DNS       â”‚ 7      â”‚ RequÃªte: 'Quelle est l'IP ?'     â•‘"
echo "â•‘  2     â”‚ DNS       â”‚ 7      â”‚ RÃ©ponse: 'IP = 93.184.216.34'    â•‘"
echo "â•‘  3     â”‚ ARP       â”‚ 2      â”‚ RequÃªte: 'MAC de passerelle ?'   â•‘"
echo "â•‘  4     â”‚ ARP       â”‚ 2      â”‚ RÃ©ponse: 'MAC = AA:BB:CC:...'    â•‘"
echo "â•‘  5     â”‚ TCP SYN   â”‚ 4      â”‚ Initiation connexion port 80     â•‘"
echo "â•‘  6     â”‚ TCP SYN-ACKâ”‚ 4     â”‚ Acceptation par serveur          â•‘"
echo "â•‘  7     â”‚ TCP ACK   â”‚ 4      â”‚ Confirmation, connexion OK       â•‘"
echo "â•‘  8     â”‚ HTTP GET  â”‚ 7      â”‚ RequÃªte de la page               â•‘"
echo "â•‘  9     â”‚ HTTP 200  â”‚ 7      â”‚ RÃ©ponse avec contenu             â•‘"
echo "â•‘  10    â”‚ TCP FIN   â”‚ 4      â”‚ Fermeture de connexion           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Pour chaque paquet, notez :"
echo ""
echo "ğŸ“¦ Couche 2 (Ethernet) :"
echo "   - Adresse MAC source"
echo "   - Adresse MAC destination"
echo "   - Type de protocole (EtherType)"
echo ""
echo "ğŸ“¦ Couche 3 (IP) :"
echo "   - Adresse IP source"
echo "   - Adresse IP destination"
echo "   - TTL"
echo ""
echo "ğŸ“¦ Couche 4 (TCP/UDP) :"
echo "   - Port source"
echo "   - Port destination"
echo "   - Flags TCP (SYN, ACK, FIN, etc.)"
echo "   - NumÃ©ros de sÃ©quence et accusÃ© de rÃ©ception"
echo ""
echo "ğŸ“¦ Couche 7 (Application) :"
echo "   - MÃ©thode HTTP (GET, POST, etc.)"
echo "   - Code de statut (200, 404, etc.)"
echo "   - Headers HTTP"
echo "   - Contenu de la rÃ©ponse"
echo ""
echo "=========================================="
echo "ğŸ“ QUESTIONS DE RÃ‰FLEXION"
echo "=========================================="
echo ""
echo "1. Pourquoi la requÃªte ARP va-t-elle vers la passerelle et non vers example.com ?"
echo ""
echo "2. Combien de paquets TCP sont nÃ©cessaires pour Ã©tablir la connexion ?"
echo ""
echo "3. Les adresses MAC changent-elles quand le paquet traverse un routeur ?"
echo ""
echo "4. Les adresses IP changent-elles (hors NAT) ?"
echo ""
echo "5. Pourquoi la rÃ©solution DNS se fait-elle en premier ?"
echo ""
echo "6. Que se passerait-il si le cache DNS avait dÃ©jÃ  l'IP d'example.com ?"
echo ""
echo "=========================================="
echo "âœ… Analyse terminÃ©e"
echo "=========================================="
